<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>ĐỀ XUẤT CẦN DUYỆT - DTA SPACE</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {font-family: Arial, sans-serif; background:#f5f5f5; margin:0; padding:20px;}
        .container {max-width:1300px; margin:auto; background:white; padding:30px; border-radius:12px; box-shadow:0 0 20px rgba(0,0,0,0.1);}
        h1 {color:#a41017; border-bottom:3px solid #a41017; padding-bottom:10px;}
        h2 {color:#d32f2f; margin-top:30px;}
        table {width:100%; border-collapse:collapse; margin:25px 0;}
        th, td {border:1px solid #ddd; padding:14px; text-align:center;}
        th {background:#a41017; color:white; font-weight:bold;}
        tr:nth-child(even) {background:#f9f9f9;}
        .btn {
            padding:10px 22px; margin:5px; text-decoration:none; border-radius:6px; color:white; font-weight:bold;
            display:inline-block; min-width:90px; font-size:14px;
        }
        .approve {background:#4caf50;}
        .approve:hover {background:#45a049;}
        .link {color:#a41017; text-decoration:none; font-weight:bold;}
        .link:hover {text-decoration:underline;}
        .no-data {text-align:center; padding:50px; color:#666; font-size:19px;}
        .status-cho {color:#ff9800; font-weight:bold;}
        .status-cap2 {color:#e65100; font-weight:bold; background:#fff3e0; padding:4px 8px; border-radius:4px;}
        .waiting {color:#888; font-style:italic;}
    </style>
</head>
<body>
<div class="container">
    <h1>Xin chào, {{ user.name }} ({{ user.role }})</h1>
    <p>
    {% if user.email != "truongkhuong@dieutuongam.com" %}
        <a href="{{ url_for('proposal') }}" class="link">Tạo đề xuất mới</a> | 
    {% endif %}
        <a href="{{ url_for('proposal_list') }}" class="link">Xem tất cả đề xuất</a> | 
        <a href="{{ url_for('logout') }}" style="color:#d32f2f;">Đăng xuất</a>
    </p>

    <h2>ĐỀ XUẤT CẦN DUYỆT ({{ pending|length }})</h2>

    {% if pending %}
    <table>
        <tr>
            <th>ID</th>
            <th>Tiêu đề</th>
            <th>Người gửi</th>
            <th>Phòng ban</th>
            <th>Ngày gửi</th>
            <th>Nguồn kinh phí</th>
            <th>Thành phố</th>
            <th>Tổng chi phí (VND)</th>
            <th>Người duyệt hiện tại</th>
            <th>Người duyệt tiếp theo</th>
            <th>Trạng thái</th>
            <th>Hành động</th>
        </tr>
        {% for p in pending %}
        <tr>
            <td><strong>#{{ p[0] }}</strong></td>
            <td style="text-align:left; font-weight:bold;">{{ p[1] }}</td>
            <td>{{ p[9] }}</td>
            <td>{{ p[3] }}</td>
            <td>{{ p[10] }}</td>
            <td>{{ p[6] or "—" }}</td>
            <td style="font-weight:bold; color:#d32f2f;">{{ p[4] or "—" }}</td>
            <td style="text-align:right; font-weight:bold; color:#a41017;">
                {% if p[13] and p[13] > 0 %}
                    {{ "{:,.0f}".format(p[13]) }}
                {% else %}
                    —
                {% endif %}
            </td>
            <td>{{ p[7] }}</td>
            <td style="background:#fff3e0; font-weight:bold; color:#d32f2f; padding:8px 12px;">
                {% if p[14] %}
                    {{ p[14] }}
                    {% if p[14].split(" - ")[0] in ["TRƯƠNG HUỆ KHƯƠNG", "NGUYỄN THỊ HỒNG TUYẾT"] %}
                        <strong style="color:#c62828;">(BOD - Cuối cùng)</strong>
                    {% endif %}
                {% else %}
                    {{ p[7] }} <em style="color:#666;">(đang duyệt đầu)</em>
                {% endif %}
            </td>
            <td>
                {% if p[11] == 'Chờ duyệt cấp 2' %}
                    <span class="status-cap2">Chờ duyệt cấp 2</span>
                {% else %}
                    <span class="status-cho">Chờ duyệt</span>
                {% endif %}
            </td>
            <td>
                {% set my_full = user.name ~ " - " ~ user.department %}
                {% set is_my_turn = (p[7] == my_full) or (p[14] and p[14]|trim == my_full) %}

                {% if is_my_turn %}
                    <a href="{{ url_for('approve', prop_id=p[0]) }}" class="btn approve">
                        {% if p[11] == 'Chờ duyệt cấp 2' %}
                            Duyệt cấp 2 (Hoàn tất)
                        {% else %}
                            Duyệt cấp 1
                        {% endif %}
                    </a>
                {% else %}
                    <span class="waiting">Đang chờ người khác</span>
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </table>
    {% else %}
    <div class="no-data">
        Hiện không có đề xuất nào cần duyệt.<br><br>
        {% if user.email != "truongkhuong@dieutuongam.com" %}
            <a href="{{ url_for('proposal') }}" style="color:#a41017; font-size:19px; font-weight:bold;">
                Tạo đề xuất mới ngay!
            </a>
        {% else %}
            Không có đề xuất nào cần duyệt.
        {% endif %}
    </div>
    {% endif %}
</div>
</body>
</html>